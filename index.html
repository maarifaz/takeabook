<!DOCTYPE html>
<html lang="az">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Infinity Library</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --bg-color: #f3f4f6;
        --card-bg: #ffffff;
        --text-main: #1f2937;
        --text-sub: #6b7280;
        --border: #e5e7eb;
        --radius: 16px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05),
          0 2px 4px -1px rgba(0, 0, 0, 0.03);
        --success: #10b981;
        --error: #ef4444;
        --warning: #f59e0b;
      }

      * {
        box-sizing: border-box;
        transition: all 0.2s ease-in-out;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        margin: 0;
        padding: 40px 20px;
        min-height: 100vh;
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
      }

      /* TOAST */
      #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        background: white;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border-left: 5px solid var(--primary);
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 250px;
        animation: slideInToast 0.3s ease;
        font-weight: 500;
        font-size: 14px;
      }
      .toast.success {
        border-left-color: var(--success);
      }
      .toast.error {
        border-left-color: var(--error);
      }
      .toast.warning {
        border-left-color: var(--warning);
      }
      @keyframes slideInToast {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* HEADER & LANG */
      .header-top {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 20px;
      }
      .lang-switch {
        background: var(--card-bg);
        padding: 5px;
        border-radius: 50px;
        display: flex;
        gap: 5px;
        box-shadow: var(--shadow);
      }
      .lang-btn {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-sub);
        padding: 6px 12px;
        border-radius: 20px;
      }
      .lang-btn:hover,
      .lang-active {
        background: var(--bg-color);
        color: var(--primary);
      }

      /* HERO */
      .hero-section {
        text-align: center;
        margin-bottom: 50px;
      }
      h1 {
        font-weight: 800;
        font-size: 2.5rem;
        margin: 0 0 10px 0;
        letter-spacing: -1px;
        background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .subtitle {
        color: var(--text-sub);
        font-size: 1.1rem;
      }

      /* ACTION AREA */
      .action-area {
        background: var(--card-bg);
        padding: 30px;
        border-radius: var(--radius);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-width: 700px;
        margin: 0 auto 40px auto;
        border: 1px solid var(--border);
      }
      .search-wrapper {
        position: relative;
        width: 100%;
      }
      .search-box {
        width: 100%;
        padding: 16px 20px 16px 50px;
        font-size: 16px;
        border: 2px solid var(--bg-color);
        border-radius: 12px;
        background: var(--bg-color);
        outline: none;
      }
      .search-box:focus {
        border-color: var(--primary);
        background: #fff;
      }
      .search-icon {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-sub);
      }

      .btn-group {
        display: flex;
        gap: 10px;
      }
      .cta-btn {
        flex: 1;
        background: var(--primary);
        color: white;
        border: none;
        padding: 16px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      .cta-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }
      .btn-secondary {
        background: #8b5cf6;
      }
      .btn-secondary:hover {
        background: #7c3aed;
      }
      .btn-excel {
        background: #10b981;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        margin-right: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .btn-excel:hover {
        background: #059669;
      }

      /* CONTENT GRID */
      .content-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 25px;
      }
      .card {
        background: var(--card-bg);
        padding: 25px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 15px;
      }
      .card-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* LISTS */
      .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--bg-color);
      }
      .list-item:last-child {
        border: none;
      }
      .rank-circle {
        width: 28px;
        height: 28px;
        background: var(--bg-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        color: var(--text-sub);
        margin-right: 10px;
      }
      .rank-1 {
        background: #fef3c7;
        color: #d97706;
      }
      .rank-2 {
        background: #f3f4f6;
        color: #4b5563;
      }
      .rank-3 {
        background: #ffedd5;
        color: #c2410c;
      }

      /* CLICKABLE NAMES */
      .clickable-name {
        cursor: pointer;
        color: var(--text-main);
        transition: color 0.2s;
      }
      .clickable-name:hover {
        color: var(--primary);
        text-decoration: underline;
      }

      /* SEARCH & TOOLTIPS & COVERS */
      #searchResult {
        margin-top: 15px;
      }
      .res-card {
        position: relative;
        background: #fff;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid var(--border);
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .res-status {
        font-size: 12px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 6px;
      }
      .st-red {
        background: #fee2e2;
        color: #991b1b;
      }
      .st-yellow {
        background: #fef3c7;
        color: #92400e;
      }

      .book-cover-wrapper {
        margin-right: 15px;
        flex-shrink: 0;
      }
      .book-cover {
        width: 45px;
        height: 65px;
        object-fit: cover;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .book-placeholder {
        width: 45px;
        height: 65px;
        background: #e5e7eb;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #9ca3af;
        font-size: 20px;
      }

      .info-wrapper {
        position: relative;
        display: inline-block;
        margin-left: 8px;
      }
      .info-icon {
        color: var(--primary);
        background: #eff6ff;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        transition: 0.2s;
      }
      .info-icon:hover {
        background: var(--primary);
        color: white;
      }

      .admin-ref-icon {
        cursor: pointer;
        margin-left: 5px;
        font-size: 16px;
        position: relative;
        display: inline-block;
      }
      .admin-ref-icon.pending {
        color: #ef4444;
        animation: pulse 2s infinite;
      }
      .admin-ref-icon.approved {
        color: #8b5cf6;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .ref-tooltip {
        visibility: hidden;
        width: 220px;
        background-color: #1f2937;
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 10px;
        position: absolute;
        z-index: 100;
        bottom: 125%;
        left: 50%;
        margin-left: -110px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
        line-height: 1.4;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }
      .ref-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #1f2937 transparent transparent transparent;
      }
      .info-wrapper:hover .ref-tooltip,
      .admin-ref-icon:hover .ref-tooltip {
        visibility: visible;
        opacity: 1;
      }

      /* ADMIN TABLE */
      .table-wrapper {
        background: var(--card-bg);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th {
        background: #f9fafb;
        text-align: left;
        padding: 16px;
        font-size: 12px;
        text-transform: uppercase;
        color: var(--text-sub);
        font-weight: 600;
      }
      td {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
        color: var(--text-main);
        font-size: 14px;
      }
      tr:hover {
        background: #f9fafb;
      }

      /* BADGES & BUTTONS */
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }
      .bg-green {
        background: #d1fae5;
        color: #065f46;
      }
      .bg-yellow {
        background: #fef3c7;
        color: #92400e;
      }
      .bg-red {
        background: #fee2e2;
        color: #991b1b;
      }
      .bg-gray {
        background: #f3f4f6;
        color: #374151;
      }
      .code-badge {
        background: #e0e7ff;
        color: #4338ca;
        font-family: monospace;
        font-size: 13px;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px dashed #4338ca;
      }
      .btn-sm {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: 0.2s;
      }
      .btn-approve {
        background: #10b981;
        color: white;
      }
      .btn-return {
        background: white;
        border: 1px solid var(--border);
        color: var(--text-main);
      }
      .btn-return:hover {
        background: var(--bg-color);
      }

      /* MODAL & AUTOCOMPLETE */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .modal-card {
        background: white;
        width: 100%;
        max-width: 400px;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        transform: scale(0.95);
        animation: zoomIn 0.2s forwards;
      }
      @keyframes zoomIn {
        to {
          transform: scale(1);
        }
      }
      .form-input,
      textarea {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-family: inherit;
        font-size: 14px;
      }
      .form-input:focus,
      textarea:focus {
        border-color: var(--primary);
        outline: none;
      }
      .suggestions-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: var(--shadow);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        margin-top: 2px;
        display: none;
      }
      .suggestion-item {
        padding: 10px 15px;
        font-size: 13px;
        color: var(--text-main);
        cursor: pointer;
        border-bottom: 1px solid var(--bg-color);
      }
      .suggestion-item:hover {
        background: var(--bg-color);
        color: var(--primary);
      }

      /* STARS */
      .star-rating {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin: 10px 0;
      }
      .star {
        font-size: 24px;
        color: #d1d5db;
        cursor: pointer;
        transition: color 0.2s;
      }
      .star.selected {
        color: #f59e0b;
      }
      .star:hover {
        transform: scale(1.2);
      }

      /* CONFIRM */
      .confirm-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .confirm-actions button {
        flex: 1;
        padding: 12px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
      }
      .btn-yes {
        background: var(--primary);
        color: white;
      }
      .btn-yes:hover {
        background: var(--primary-dark);
      }
      .btn-no {
        background: #f3f4f6;
        color: var(--text-main);
      }
      .btn-no:hover {
        background: #e5e7eb;
      }

      /* DETAILS LIST */
      .detail-list {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 10px;
      }
      .detail-item {
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
      }
      .detail-item:last-child {
        border: none;
      }
      .detail-header {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .detail-sub {
        font-size: 12px;
        color: #6b7280;
        display: flex;
        justify-content: space-between;
      }
      .detail-text {
        font-size: 13px;
        color: #374151;
        margin-top: 5px;
        font-style: italic;
        background: #f9fafb;
        padding: 8px;
        border-radius: 6px;
      }

      .admin-link {
        text-align: center;
        margin-top: 40px;
        font-size: 13px;
        color: var(--text-sub);
        cursor: pointer;
      }
      .admin-link:hover {
        text-decoration: underline;
        color: var(--primary);
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div id="toast-container"></div>

    <div class="header-top">
      <div class="lang-switch">
        <button class="lang-btn" onclick="changeLanguage('az')">AZ</button>
        <button class="lang-btn" onclick="changeLanguage('tr')">TR</button>
        <button class="lang-btn" onclick="changeLanguage('en')">EN</button>
        <button class="lang-btn" onclick="changeLanguage('ru')">RU</button>
      </div>
    </div>

    <div class="container">
      <div id="studentSection">
        <div class="hero-section">
          <h1 data-i18n="app_title">Infinity Library</h1>
          <div class="subtitle" data-i18n="app_subtitle">
            G…ôl…ôc…ôyi oxuyaraq k…ô≈üf et
          </div>
        </div>

        <div class="action-area">
          <div class="search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input
              type="text"
              id="studentSearch"
              class="search-box"
              data-placeholder="search_ph"
              placeholder="Kitab axtar..."
              onkeyup="checkBookStatus()"
            />
          </div>
          <div id="searchResult"></div>
          <div class="btn-group">
            <button class="cta-btn" onclick="openModal('order')">
              <span data-i18n="btn_order">Kitab Sifari≈ü Et</span>
              <i class="fas fa-arrow-right"></i>
            </button>
            <button
              class="cta-btn btn-secondary"
              onclick="openModal('reflection')"
            >
              <span data-i18n="btn_reflection">‚úçÔ∏è R…ôy Yaz</span>
            </button>
          </div>
        </div>

        <div class="content-grid">
          <div class="card">
            <div class="card-header">
              <span class="card-title"
                ><i class="far fa-clock"></i>
                <span data-i18n="recent_title">Son Aktivlik</span></span
              >
            </div>
            <div id="recentList">
              <p style="color: #999; font-size: 13px" data-i18n="loading">
                Y√ºkl…ônir...
              </p>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <span class="card-title"
                ><i class="fas fa-crown" style="color: #fbbf24"></i>
                <span data-i18n="top_readers">H…ôft…ônin Liderl…ôri</span></span
              >
            </div>
            <div id="topReadersList">
              <p style="color: #999; font-size: 13px" data-i18n="loading">
                Y√ºkl…ônir...
              </p>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <span class="card-title"
                ><i class="fas fa-fire" style="color: #ef4444"></i>
                <span data-i18n="top_books">Trend Kitablar</span></span
              >
            </div>
            <div id="topBooksList">
              <p style="color: #999; font-size: 13px" data-i18n="loading">
                Y√ºkl…ônir...
              </p>
            </div>
          </div>
        </div>

        <div class="admin-link" onclick="openModal('teacherLogin')">
          <i class="fas fa-shield-alt"></i>
          <span data-i18n="teacher_login">M√º…ôllim Giri≈üi</span>
        </div>
      </div>

      <div id="adminSection" class="hidden">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
          "
        >
          <h2
            style="margin: 0; color: var(--text-main)"
            data-i18n="admin_panel"
          >
            ƒ∞dar…ôetm…ô Paneli
          </h2>
          <div style="display: flex">
            <button onclick="exportToExcel()" class="btn-excel">
              <i class="fas fa-file-excel"></i> Excel
            </button>
            <button
              onclick="showStudent()"
              class="btn-sm"
              style="background: #ef4444; color: white; border: none"
              data-i18n="btn_exit"
            >
              √áƒ±xƒ±≈ü
            </button>
          </div>
        </div>
        <div style="margin-bottom: 20px">
          <input
            type="text"
            id="adminSearch"
            class="form-input"
            data-placeholder="admin_search_ph"
            placeholder="Jurnalda axtar..."
            onkeyup="filterAdminTable()"
            style="max-width: 300px; margin: 0"
          />
        </div>
        <div class="table-wrapper">
          <table id="adminTable">
            <thead>
              <tr>
                <th data-i18n="th_student">≈ûagird</th>
                <th data-i18n="th_book">Kitab</th>
                <th data-i18n="th_date">Tarix</th>
                <th data-i18n="th_term">Qalan</th>
                <th data-i18n="th_status">Status</th>
                <th data-i18n="th_action" style="text-align: right">
                  ∆èm…ôliyyat
                </th>
              </tr>
            </thead>
            <tbody id="logsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="orderModal" class="modal-overlay">
      <div class="modal-card">
        <h3 style="margin-top: 0; text-align: center" data-i18n="modal_title">
          Yeni Sifari≈ü
        </h3>

        <div style="position: relative">
          <input
            type="text"
            id="bTitle"
            class="form-input"
            data-placeholder="ph_book_name"
            placeholder="Kitabƒ±n Adƒ±"
            autocomplete="off"
            oninput="searchBooksForModal(this.value)"
          />
          <div id="bookSuggestions" class="suggestions-dropdown"></div>
        </div>

        <div style="position: relative">
          <input
            type="text"
            id="sName"
            class="form-input"
            data-placeholder="ph_student_name"
            placeholder="Ad v…ô Soyad"
            autocomplete="off"
            oninput="searchStudentsForModal(this.value)"
          />
          <div id="studentSuggestions" class="suggestions-dropdown"></div>
        </div>

        <input
          type="text"
          id="sClass"
          class="form-input"
          data-placeholder="ph_class"
          placeholder="Sinif"
        />

        <button
          onclick="saveData()"
          class="cta-btn"
          style="width: 100%; margin-top: 15px; justify-content: center"
          data-i18n="btn_submit"
        >
          T…ôsdiql…ô
        </button>
        <button
          onclick="closeModal('order')"
          style="
            width: 100%;
            background: none;
            border: none;
            color: #999;
            margin-top: 10px;
            cursor: pointer;
          "
          data-i18n="btn_cancel"
        >
          L…ôƒüv et
        </button>
      </div>
    </div>

    <div id="reflectionModal" class="modal-overlay">
      <div class="modal-card">
        <h3
          style="margin-top: 0; text-align: center"
          data-i18n="modal_ref_title"
        >
          R…ôy Yaz (Reflection)
        </h3>

        <div id="refStep1">
          <p
            style="color: #666; font-size: 13px; text-align: center"
            data-i18n="lbl_enter_code"
          >
            5 r…ôq…ômli kodu daxil et:
          </p>
          <input
            type="text"
            id="refCode"
            class="form-input"
            placeholder="Kod (M…ôs: 12345)"
            style="text-align: center; font-size: 18px; letter-spacing: 2px"
          />
          <button
            onclick="verifyRefCode()"
            class="cta-btn"
            style="width: 100%; margin-top: 10px; justify-content: center"
          >
            Davam Et
          </button>
        </div>

        <div id="refStep2" class="hidden">
          <p
            id="refBookInfo"
            style="
              font-weight: bold;
              color: var(--primary);
              text-align: center;
              margin-bottom: 10px;
            "
          ></p>
          <div class="star-rating" id="starRating">
            <span class="star" onclick="setRating(1)">‚òÖ</span>
            <span class="star" onclick="setRating(2)">‚òÖ</span>
            <span class="star" onclick="setRating(3)">‚òÖ</span>
            <span class="star" onclick="setRating(4)">‚òÖ</span>
            <span class="star" onclick="setRating(5)">‚òÖ</span>
          </div>
          <textarea
            id="refText"
            rows="4"
            maxlength="100"
            placeholder="Kitab haqqƒ±nda fikirl…ôrin (Max 100 h…ôrf)..."
          ></textarea>
          <button
            onclick="saveReflection()"
            class="cta-btn"
            style="width: 100%; margin-top: 10px; justify-content: center"
          >
            G√∂nd…ôr
          </button>
        </div>

        <button
          onclick="closeModal('reflection')"
          style="
            width: 100%;
            background: none;
            border: none;
            color: #999;
            margin-top: 10px;
            cursor: pointer;
          "
          data-i18n="btn_cancel"
        >
          L…ôƒüv et
        </button>
      </div>
    </div>

    <div id="teacherLoginModal" class="modal-overlay">
      <div class="modal-card">
        <h3 style="margin-top: 0; text-align: center" data-i18n="teacher_login">
          M√º…ôllim Giri≈üi
        </h3>
        <p
          style="
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-bottom: 15px;
          "
        >
          Giri≈ü √º√ß√ºn ≈üifr…ôni daxil edin
        </p>
        <input
          type="password"
          id="teacherPassInput"
          class="form-input"
          style="text-align: center; letter-spacing: 2px"
          placeholder="******"
        />
        <button
          onclick="submitTeacherLogin()"
          class="cta-btn"
          style="width: 100%; margin-top: 10px; justify-content: center"
        >
          Daxil Ol
        </button>
        <button
          onclick="closeModal('teacherLogin')"
          style="
            width: 100%;
            background: none;
            border: none;
            color: #999;
            margin-top: 10px;
            cursor: pointer;
          "
          data-i18n="btn_cancel"
        >
          L…ôƒüv et
        </button>
      </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
      <div class="modal-card">
        <h3 style="margin-top: 0; text-align: center; color: var(--text-main)">
          T…ôsdiql…ô
        </h3>
        <p
          id="confirmMessage"
          style="
            text-align: center;
            color: #555;
            font-size: 15px;
            margin-bottom: 20px;
          "
        >
          ∆èminsiniz?
        </p>
        <div class="confirm-actions">
          <button onclick="closeModal('confirm')" class="btn-no">Xeyr</button>
          <button id="confirmBtnYes" class="btn-yes">B…ôli</button>
        </div>
      </div>
    </div>

    <div id="bookDetailsModal" class="modal-overlay">
      <div class="modal-card" style="max-width: 500px">
        <h3
          id="detailBookTitle"
          style="margin-top: 0; text-align: center; color: var(--primary)"
        >
          Kitab Adƒ±
        </h3>
        <div id="detailBookContent" class="detail-list">Loading...</div>
        <button
          onclick="closeModal('bookDetails')"
          style="
            width: 100%;
            background: none;
            border: none;
            color: #999;
            margin-top: 10px;
            cursor: pointer;
          "
        >
          Baƒüla
        </button>
      </div>
    </div>

    <div id="studentDetailsModal" class="modal-overlay">
      <div class="modal-card" style="max-width: 500px">
        <h3
          id="detailStudentName"
          style="margin-top: 0; text-align: center; color: var(--primary)"
        >
          ≈ûagird Adƒ±
        </h3>
        <div id="detailStudentContent" class="detail-list">Loading...</div>
        <button
          onclick="closeModal('studentDetails')"
          style="
            width: 100%;
            background: none;
            border: none;
            color: #999;
            margin-top: 10px;
            cursor: pointer;
          "
        >
          Baƒüla
        </button>
      </div>
    </div>

    <script>
      const SUPABASE_URL = "https://awcpvqlqpxlavezlbszq.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3Y3B2cWxxcHhsYXZlemxic3pxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NTYzNzAsImV4cCI6MjA4MjEzMjM3MH0.yHYa9zm6U0HsGDftxsdk-f6kr4dpc4xy_xYk6KO5SUM";
      let sb;
      let allLogs = [];
      let currentLang = localStorage.getItem("lang") || "az";
      let currentRefId = null;
      let currentRating = 0;

      const translations = {
        az: {
          app_title: "Infinity Library",
          app_subtitle: "Bilik sonsuzluqdur, k…ô≈üf etm…ôy…ô ba≈üla.",
          search_ph: "üîç Kitab axtar...",
          btn_order: "Kitab Sifari≈ü Et",
          btn_reflection: "‚úçÔ∏è R…ôy Yaz",
          recent_title: "Son Aktivlik",
          top_readers: "H…ôft…ônin Liderl…ôri",
          top_books: "Trend Kitablar",
          teacher_login: "M√º…ôllim Giri≈üi",
          admin_panel: "Admin Panel",
          btn_exit: "√áƒ±xƒ±≈ü",
          admin_search_ph: "üîç Jurnalda axtar...",
          th_student: "≈ûagird",
          th_book: "Kitab",
          th_date: "Tarix",
          th_term: "Qalan",
          th_status: "Status",
          th_action: "∆èm…ôliyyat",
          modal_title: "Sifari≈ü Formu",
          modal_ref_title: "R…ôy Yaz",
          lbl_enter_code: "5 r…ôq…ômli kodu daxil et:",
          ph_book_name: "Kitabƒ±n Adƒ± (Yazmaƒüa ba≈üla...)",
          ph_student_name: "Ad v…ô Soyad (Yazmaƒüa ba≈üla...)",
          ph_class: "Sinif",
          btn_submit: "T…ôsdiql…ô",
          btn_cancel: "Baƒüla",
          loading: "Y√ºkl…ônir...",
          no_data: "M…ôlumat yoxdur",
          status_pending: "G√∂zl…ôyir",
          status_active: "Oxunur",
          status_returned: "Bitdi",
          lbl_confirm_wait: "T…ôsdiq G√∂zl…ôyir",
          btn_approve: "T…ôsdiql…ô",
          btn_return: "Qaytar",
          alert_approve: "T…ôsdiq edirsiniz?",
          alert_return: "Qaytarƒ±ldƒ±?",
          alert_wrong_pass: "Yanlƒ±≈ü ≈üifr…ô!",
          days_left: "g√ºn",
          unnamed: "Adsƒ±z Kitab",
          code_lbl: "Kod",
          toast_success: "‚úÖ Uƒüurlu …ôm…ôliyyat!",
          toast_error: "‚ùå X…ôta ba≈ü verdi!",
          toast_fill: "‚ö†Ô∏è Xanalarƒ± doldurun!",
          toast_code_used: "‚ö†Ô∏è Bu kod artƒ±q istifad…ô olunub!",
          toast_not_returned: "‚ö†Ô∏è Kitabƒ± h…ôl…ô t…ôhvil verm…ômisiniz!",
          lbl_shelf: "R…ôf",
          shelf_000: "000 - √úmumi ∆ès…ôrl…ôr",
          shelf_100: "100 - F…ôls…ôf…ô v…ô Psixologiya",
          shelf_200: "200 - Din",
          shelf_300: "300 - Sosial Elml…ôr",
          shelf_400: "400 - Dil",
          shelf_500: "500 - Elm",
          shelf_600: "600 - Texnologiya",
          shelf_700: "700 - ƒ∞nc…ôs…ôn…ôt v…ô ƒ∞dman",
          shelf_800: "800 - ∆èd…ôbiyyat",
          shelf_900: "900 - Tarix v…ô Coƒürafiya",
        },
        en: {
          app_title: "Infinity Library",
          app_subtitle: "Knowledge is infinite.",
          search_ph: "üîç Search books...",
          btn_order: "Order Book",
          btn_reflection: "‚úçÔ∏è Reflection",
          recent_title: "Recent Activity",
          top_readers: "Top Readers",
          top_books: "Trending Books",
          teacher_login: "Teacher Access",
          admin_panel: "Admin Dashboard",
          btn_exit: "Logout",
          admin_search_ph: "üîç Search logs...",
          th_student: "Student",
          th_book: "Book",
          th_date: "Date",
          th_term: "Left",
          th_status: "Status",
          th_action: "Action",
          modal_title: "New Order",
          modal_ref_title: "Write Reflection",
          lbl_enter_code: "Enter 5-digit code:",
          ph_book_name: "Book Title...",
          ph_student_name: "Full Name (Start typing...)",
          ph_class: "Class",
          btn_submit: "Submit",
          btn_cancel: "Close",
          loading: "Loading...",
          no_data: "No data",
          status_pending: "Pending",
          status_active: "Reading",
          status_returned: "Done",
          lbl_confirm_wait: "Pending",
          btn_approve: "Approve",
          btn_return: "Return",
          alert_approve: "Approve?",
          alert_return: "Returned?",
          alert_wrong_pass: "Wrong password!",
          days_left: "days",
          unnamed: "Unnamed",
          code_lbl: "Code",
          toast_success: "‚úÖ Success!",
          toast_error: "‚ùå Error!",
          toast_fill: "‚ö†Ô∏è Fill fields!",
          toast_code_used: "‚ö†Ô∏è Code already used!",
          toast_not_returned: "‚ö†Ô∏è Book not returned yet!",
          lbl_shelf: "Shelf",
          shelf_000: "000 - General Works",
          shelf_100: "100 - Philosophy & Psychology",
          shelf_200: "200 - Religion",
          shelf_300: "300 - Social Sciences",
          shelf_400: "400 - Language",
          shelf_500: "500 - Science",
          shelf_600: "600 - Technology",
          shelf_700: "700 - Arts & Recreation",
          shelf_800: "800 - Literature",
          shelf_900: "900 - History & Geography",
        },
        tr: {
          app_title: "Infinity Library",
          app_subtitle: "Bilgi sonsuzdur.",
          search_ph: "üîç Kitap ara...",
          btn_order: "Kitap ƒ∞ste",
          btn_reflection: "‚úçÔ∏è Yorum Yaz",
          recent_title: "Son Hareketler",
          top_readers: "Liderler",
          top_books: "Trendler",
          teacher_login: "√ñƒüretmen Giri≈üi",
          admin_panel: "Y√∂netim Paneli",
          btn_exit: "√áƒ±kƒ±≈ü",
          admin_search_ph: "üîç Ara...",
          th_student: "√ñƒürenci",
          th_book: "Kitap",
          th_date: "Tarih",
          th_term: "Kalan",
          th_status: "Durum",
          th_action: "ƒ∞≈ülem",
          modal_title: "Kitap ƒ∞ste",
          modal_ref_title: "Yorum Yaz",
          lbl_enter_code: "5 haneli kodu gir:",
          ph_book_name: "Kitap Adƒ±...",
          ph_student_name: "Ad Soyad (Yazmaya ba≈üla...)",
          ph_class: "Sƒ±nƒ±f",
          btn_submit: "G√∂nder",
          btn_cancel: "Kapat",
          loading: "Y√ºkleniyor...",
          no_data: "Veri yok",
          status_pending: "Bekliyor",
          status_active: "Okuyor",
          status_returned: "Bitti",
          lbl_confirm_wait: "Onay Bekliyor",
          btn_approve: "Onayla",
          btn_return: "ƒ∞ade Al",
          alert_approve: "Onaylƒ±yor musun?",
          alert_return: "ƒ∞ade edildi mi?",
          alert_wrong_pass: "Hatalƒ± ≈üifre!",
          days_left: "g√ºn",
          unnamed: "Adsƒ±z",
          code_lbl: "Kod",
          toast_success: "‚úÖ Ba≈üarƒ±lƒ±!",
          toast_error: "‚ùå Hata!",
          toast_fill: "‚ö†Ô∏è Alanlarƒ± doldurun!",
          toast_code_used: "‚ö†Ô∏è Bu kod daha √∂nce kullanƒ±ldƒ±!",
          toast_not_returned: "‚ö†Ô∏è Kitabƒ± hen√ºz teslim etmediniz!",
          lbl_shelf: "Raf",
          shelf_000: "000 - Genel Eserler",
          shelf_100: "100 - Felsefe ve Psikoloji",
          shelf_200: "200 - Din",
          shelf_300: "300 - Sosyal Bilimler",
          shelf_400: "400 - Dil",
          shelf_500: "500 - Bilim",
          shelf_600: "600 - Teknoloji",
          shelf_700: "700 - G√ºzel Sanatlar",
          shelf_800: "800 - Edebiyat",
          shelf_900: "900 - Tarih ve Coƒürafya",
        },
        ru: {
          app_title: "Infinity Library",
          app_subtitle: "–ó–Ω–∞–Ω–∏–µ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ.",
          search_ph: "üîç –ü–æ–∏—Å–∫...",
          btn_order: "–ó–∞–∫–∞–∑–∞—Ç—å",
          btn_reflection: "‚úçÔ∏è –û—Ç–∑—ã–≤",
          recent_title: "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
          top_readers: "–¢–æ–ø –ß–∏—Ç–∞—Ç–µ–ª–∏",
          top_books: "–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ",
          teacher_login: "–í—Ö–æ–¥ –£—á–∏—Ç–µ–ª—è",
          admin_panel: "–ü–∞–Ω–µ–ª—å",
          btn_exit: "–í—ã—Ö–æ–¥",
          admin_search_ph: "üîç –ü–æ–∏—Å–∫...",
          th_student: "–£—á–µ–Ω–∏–∫",
          th_book: "–ö–Ω–∏–≥–∞",
          th_date: "–î–∞—Ç–∞",
          th_term: "–û—Å—Ç.",
          th_status: "–°—Ç–∞—Ç—É—Å",
          th_action: "–î–µ–π—Å—Ç–≤–∏–µ",
          modal_title: "–ù–æ–≤—ã–π –ó–∞–∫–∞–∑",
          modal_ref_title: "–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤",
          lbl_enter_code: "–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥:",
          ph_book_name: "–ù–∞–∑–≤–∞–Ω–∏–µ...",
          ph_student_name: "–§–ò–û (–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å...)",
          ph_class: "–ö–ª–∞—Å—Å",
          btn_submit: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
          btn_cancel: "–ó–∞–∫—Ä—ã—Ç—å",
          loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
          no_data: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö",
          status_pending: "–û–∂–∏–¥–∞–Ω–∏–µ",
          status_active: "–ß–∏—Ç–∞–µ—Ç",
          status_returned: "–í–µ—Ä–Ω—É–ª",
          lbl_confirm_wait: "–ñ–¥–µ—Ç",
          btn_approve: "–û–¥–æ–±—Ä–∏—Ç—å",
          btn_return: "–í–µ—Ä–Ω—É—Ç—å",
          alert_approve: "–í—ã–¥–∞—Ç—å?",
          alert_return: "–í–µ—Ä–Ω—É–ª–∏?",
          alert_wrong_pass: "–û—à–∏–±–∫–∞!",
          days_left: "–¥–Ω.",
          unnamed: "–ë–µ–∑ –Ω–∞–∑–≤.",
          code_lbl: "–ö–æ–¥",
          toast_success: "‚úÖ –£—Å–ø–µ—à–Ω–æ!",
          toast_error: "‚ùå –û—à–∏–±–∫–∞!",
          toast_fill: "‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!",
          toast_code_used: "‚ö†Ô∏è –ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!",
          toast_not_returned: "‚ö†Ô∏è –ö–Ω–∏–≥–∞ –µ—â–µ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞!",
          lbl_shelf: "–ü–æ–ª–∫–∞",
          shelf_000: "000 - –û–±—â–∏–µ —Ä–∞–±–æ—Ç—ã",
          shelf_100: "100 - –§–∏–ª–æ—Å–æ—Ñ–∏—è –∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è",
          shelf_200: "200 - –†–µ–ª–∏–≥–∏—è",
          shelf_300: "300 - –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞—É–∫–∏",
          shelf_400: "400 - –Ø–∑—ã–∫",
          shelf_500: "500 - –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–∞—É–∫–∏",
          shelf_600: "600 - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è",
          shelf_700: "700 - –ò—Å–∫—É—Å—Å—Ç–≤–æ –∏ —Å–ø–æ—Ä—Ç",
          shelf_800: "800 - –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞",
          shelf_900: "900 - –ò—Å—Ç–æ—Ä–∏—è –∏ –≥–µ–æ–≥—Ä–∞—Ñ–∏—è",
        },
      };

      function t(key) {
        return translations[currentLang][key] || key;
      }

      // HELPER: TRANSLATE SHELF LOCATION DYNAMICALLY
      function getTranslatedShelf(originalStr) {
        if (!originalStr) return "";
        // Dewey kodunu √ßƒ±xar (ƒ∞lk 3 r…ôq…ôm)
        const match = originalStr.match(/^\d{3}/);
        if (match) {
          const code = match[0];
          // Y√ºzl√ºk kateqoriyaya yuvarlaqla≈üdƒ±r (M…ôs: 813 -> 800)
          const roundedCode = code.charAt(0) + "00";
          const key = `shelf_${roundedCode}`;
          return translations[currentLang][key] || originalStr;
        }
        return originalStr;
      }

      function changeLanguage(lang) {
        currentLang = lang;
        localStorage.setItem("lang", lang);
        document.querySelectorAll(".lang-btn").forEach((btn) => {
          btn.classList.remove("lang-active");
          if (btn.innerText.includes(lang.toUpperCase()))
            btn.classList.add("lang-active");
        });
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          if (translations[lang][el.getAttribute("data-i18n")])
            el.innerText = translations[lang][el.getAttribute("data-i18n")];
        });
        document.querySelectorAll("[data-placeholder]").forEach((el) => {
          if (translations[lang][el.getAttribute("data-placeholder")])
            el.placeholder =
              translations[lang][el.getAttribute("data-placeholder")];
        });
        if (allLogs.length > 0) fetchAllLogsForSystem();
      }

      window.onload = async function () {
        if (!window.supabase) return showToast("Offline!", "error");
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        changeLanguage(currentLang);
        await fetchAllLogsForSystem();
      };

      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = message;
        container.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      function customConfirm(message, onConfirm) {
        const modal = document.getElementById("confirmModal");
        const msgEl = document.getElementById("confirmMessage");
        const yesBtn = document.getElementById("confirmBtnYes");

        msgEl.innerText = message;
        modal.style.display = "flex";

        const newYesBtn = yesBtn.cloneNode(true);
        yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);

        newYesBtn.onclick = function () {
          onConfirm();
          modal.style.display = "none";
        };
      }

      function submitTeacherLogin() {
        const today = new Date();
        const correctPass = `${String(today.getDate()).padStart(
          2,
          "0"
        )}${String(today.getMonth() + 1).padStart(
          2,
          "0"
        )}${today.getFullYear()}`;
        const userPass = document.getElementById("teacherPassInput").value;
        if (userPass === correctPass) {
          showAdmin();
          closeModal("teacherLogin");
          document.getElementById("teacherPassInput").value = "";
        } else {
          showToast(t("alert_wrong_pass"), "error");
        }
      }

      function setRating(n) {
        currentRating = n;
        document.querySelectorAll(".star").forEach((star, index) => {
          if (index < n) star.classList.add("selected");
          else star.classList.remove("selected");
        });
      }

      async function approveBook(id) {
        customConfirm(t("alert_approve"), async () => {
          const now = new Date().toISOString();
          const code = Math.floor(10000 + Math.random() * 90000).toString();
          const { error } = await sb
            .from("library_logs")
            .update({ status: "active", borrow_date: now, secret_code: code })
            .eq("id", id);
          if (!error) {
            showToast(t("toast_success"), "success");
            fetchAllLogsForSystem();
          }
        });
      }

      async function approveReflection(id) {
        customConfirm("Bu r…ôyi t…ôsdiq edirsiniz?", async () => {
          const { error } = await sb
            .from("library_logs")
            .update({ is_reflection_approved: true })
            .eq("id", id);
          if (!error) {
            showToast("R…ôy t…ôsdiql…ôndi!", "success");
            fetchAllLogsForSystem();
          }
        });
      }

      async function verifyRefCode() {
        const code = document.getElementById("refCode").value.trim();
        if (code.length !== 5)
          return showToast("Kod 5 r…ôq…ômli olmalƒ±dƒ±r!", "error");

        const { data, error } = await sb
          .from("library_logs")
          .select("*")
          .eq("secret_code", code)
          .single();

        if (error || !data) {
          showToast("Kod tapƒ±lmadƒ±!", "error");
        } else if (data.status !== "returned") {
          showToast(t("toast_not_returned"), "warning"); // MUST BE RETURNED
        } else if (data.reflection && data.reflection.length > 0) {
          showToast(t("toast_code_used"), "warning");
        } else {
          currentRefId = data.id;
          currentRating = 0;
          setRating(0);
          document.getElementById("refStep1").classList.add("hidden");
          document.getElementById("refStep2").classList.remove("hidden");
          document.getElementById(
            "refBookInfo"
          ).innerText = `${data.book_title} (${data.student_name})`;
        }
      }

      async function saveReflection() {
        const text = document.getElementById("refText").value;
        if (!text) return showToast("R…ôy yazƒ±n!", "warning");
        const { error } = await sb
          .from("library_logs")
          .update({
            reflection: text,
            rating: currentRating,
            is_reflection_approved: false,
          })
          .eq("id", currentRefId);
        if (!error) {
          showToast(
            "T…ô≈ü…ôkk√ºrl…ôr! R…ôyiniz m√º…ôllim t…ôr…ôfind…ôn yoxlanacaq.",
            "success"
          );
          closeModal("reflection");
          fetchAllLogsForSystem();
        }
      }

      async function fetchBookCover(title) {
        try {
          const res = await fetch(
            `https://www.googleapis.com/books/v1/volumes?q=intitle:${encodeURIComponent(
              title
            )}&maxResults=1`
          );
          const data = await res.json();
          if (data.items && data.items[0].volumeInfo.imageLinks) {
            return data.items[0].volumeInfo.imageLinks.smallThumbnail;
          }
        } catch (e) {
          console.error(e);
        }
        return null;
      }

      async function checkBookStatus() {
        const query = document
          .getElementById("studentSearch")
          .value.trim()
          .toLowerCase();
        const resultDiv = document.getElementById("searchResult");
        resultDiv.innerHTML = "";
        if (query.length < 2) return;

        const { data: foundBooks } = await sb
          .from("books")
          .select("*")
          .ilike("title", `%${query}%`)
          .limit(5);
        if (!foundBooks || foundBooks.length === 0) {
          resultDiv.innerHTML = `<p style="text-align:center; color:#999; font-size:13px;">${t(
            "no_data"
          )}</p>`;
          return;
        }

        for (let book of foundBooks) {
          const logs = allLogs.filter(
            (l) =>
              l.book_title &&
              l.book_title.toLowerCase() === book.title.toLowerCase()
          );
          const activeCount = logs.filter((l) => l.status === "active").length;
          const available = book.quantity - activeCount;
          let statusBadge =
            available > 0
              ? `<span class="res-status" style="background:#d1fae5; color:#065f46">M√∂vcud: ${available}</span>`
              : `<span class="res-status st-red">Bitib (0)</span>`;

          const reflections = logs.filter(
            (l) => l.reflection && l.is_reflection_approved
          );
          let reflectionHtml = "";
          if (reflections.length > 0) {
            const randomLog =
              reflections[Math.floor(Math.random() * reflections.length)];
            const stars = randomLog.rating ? "‚≠ê".repeat(randomLog.rating) : "";
            reflectionHtml = `<div class="info-wrapper"><div class="info-icon"><i class="fas fa-info"></i></div><div class="ref-tooltip">${stars}<br><i class="fas fa-quote-left" style="color:#aaa; margin-right:5px;"></i> ${randomLog.reflection}</div></div>`;
          }

          const coverUrl = await fetchBookCover(book.title);
          const imageHtml = coverUrl
            ? `<div class="book-cover-wrapper"><img src="${coverUrl}" class="book-cover" alt="Cover"></div>`
            : `<div class="book-cover-wrapper"><div class="book-placeholder"><i class="fas fa-book"></i></div></div>`;

          // Dƒ∞NAMƒ∞K T∆èRC√úM∆è EDƒ∞LMƒ∞≈û R∆èF ADI
          const translatedShelf = getTranslatedShelf(book.shelf_location);
          const shelfBadge = translatedShelf
            ? `<div style="font-size:11px; color:#4b5563; background:#f3f4f6; padding:2px 6px; border-radius:4px; display:inline-block; margin-top:4px;">üìç ${t(
                "lbl_shelf"
              )}: ${translatedShelf}</div>`
            : "";

          resultDiv.innerHTML += `
            <div class="res-card">
                <div style="display:flex; align-items:center;">
                    ${imageHtml}
                    <div>
                        <div style="font-weight:700; font-size:14px;">${
                          book.title
                        }</div>
                        <div style="font-size:12px; color:#666;">${
                          book.author || ""
                        }</div>
                        ${shelfBadge}
                    </div>
                    ${reflectionHtml}
                </div>
                <div style="text-align:right;">${statusBadge}</div>
            </div>`;
        }
      }

      function exportToExcel() {
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        csvContent += "≈ûagird,Sinif,Kitab,Status,Tarix,R…ôy,Ulduz\n";
        allLogs.forEach((row) => {
          const r = row.reflection ? row.reflection.replace(/,/g, " ") : "";
          const rt = row.rating ? row.rating : "";
          csvContent += `${row.student_name},${row.student_class},${row.book_title},${row.status},${row.borrow_date},${r},${rt}\n`;
        });
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "kitabxana_jurnali.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast("Excel faylƒ± endirildi!", "success");
      }

      let searchTimeout;
      async function searchBooksForModal(query) {
        const listDiv = document.getElementById("bookSuggestions");
        if (query.length < 2) {
          listDiv.style.display = "none";
          return;
        }
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
          const { data } = await sb
            .from("books")
            .select("*")
            .ilike("title", `%${query}%`)
            .limit(5);
          listDiv.innerHTML = "";
          if (data && data.length > 0) {
            listDiv.style.display = "block";
            data.forEach((book) => {
              const activeCount = allLogs.filter(
                (l) =>
                  l.book_title &&
                  l.book_title.toLowerCase() === book.title.toLowerCase() &&
                  l.status === "active"
              ).length;
              const available = book.quantity - activeCount;

              // Dƒ∞NAMƒ∞K T∆èRC√úM∆è EDƒ∞LMƒ∞≈û R∆èF ADI
              const translatedShelf = getTranslatedShelf(book.shelf_location);

              const item = document.createElement("div");
              item.className = "suggestion-item";
              item.innerHTML = `${
                book.title
              } <span style="font-size:11px; color:${
                available > 0 ? "green" : "red"
              }">(M√∂vcud: ${available})</span> <br><small style="color:#666">üìç ${
                translatedShelf || "800 - " + t("shelf_800").split(" - ")[1]
              }</small>`;
              item.onclick = () => {
                document.getElementById("bTitle").value = book.title;
                listDiv.style.display = "none";
              };
              listDiv.appendChild(item);
            });
          } else {
            listDiv.style.display = "none";
          }
        }, 300);
      }

      let studentSearchTimeout;
      async function searchStudentsForModal(query) {
        const listDiv = document.getElementById("studentSuggestions");
        if (query.length < 2) {
          listDiv.style.display = "none";
          return;
        }
        clearTimeout(studentSearchTimeout);
        studentSearchTimeout = setTimeout(async () => {
          const { data } = await sb
            .from("students")
            .select("*")
            .ilike("full_name", `%${query}%`)
            .limit(5);
          listDiv.innerHTML = "";
          if (data && data.length > 0) {
            listDiv.style.display = "block";
            data.forEach((st) => {
              const item = document.createElement("div");
              item.className = "suggestion-item";
              item.innerText = `${st.full_name} (${st.class_name})`;
              item.onclick = () => {
                document.getElementById("sName").value = st.full_name;
                document.getElementById("sClass").value = st.class_name;
                listDiv.style.display = "none";
              };
              listDiv.appendChild(item);
            });
          } else {
            listDiv.style.display = "none";
          }
        }, 300);
      }

      async function saveData() {
        const title = document.getElementById("bTitle").value;
        const name = document.getElementById("sName").value;
        const cls = document.getElementById("sClass").value;
        if (!title || !name) return showToast(t("toast_fill"), "warning");
        const { error } = await sb
          .from("library_logs")
          .insert([
            {
              book_title: title,
              student_name: name,
              student_class: cls,
              status: "pending",
            },
          ]);
        if (error) showToast("Error: " + error.message, "error");
        else {
          showToast(t("toast_success"), "success");
          closeModal("order");
          fetchAllLogsForSystem();
        }
      }

      async function fetchAllLogsForSystem() {
        const { data } = await sb
          .from("library_logs")
          .select("*")
          .order("borrow_date", { ascending: false });
        if (data) {
          allLogs = data;
          renderRecentBooks(allLogs);
          calculateTopLists(allLogs);
          if (
            !document
              .getElementById("adminSection")
              .classList.contains("hidden")
          )
            renderAdminTable(allLogs);
        }
      }

      function renderRecentBooks(data) {
        const listDiv = document.getElementById("recentList");
        const recent = data.slice(0, 5);
        if (recent.length === 0) {
          listDiv.innerHTML = `<p style='text-align:center; color:#999;'>${t(
            "no_data"
          )}</p>`;
          return;
        }
        listDiv.innerHTML = "";
        recent.forEach((item) => {
          let statusText = "",
            colorClass = "";
          if (item.status === "pending") {
            statusText = t("status_pending");
            colorClass = "bg-yellow";
          } else if (item.status === "returned") {
            statusText = t("status_returned");
            colorClass = "bg-gray";
          } else {
            statusText = t("status_active");
            colorClass = "bg-green";
          }
          listDiv.innerHTML += `<div class="list-item"><div><div style="font-weight:600; font-size:14px; color:var(--text-main);">${
            item.book_title || t("unnamed")
          }</div><div style="font-size:12px; color:var(--text-sub);">${
            item.student_name
          }</div></div><span class="badge ${colorClass}">${statusText}</span></div>`;
        });
      }

      function calculateTopLists(data) {
        const bookCounts = {};
        data.forEach((item) => {
          if (item.book_title)
            bookCounts[item.book_title.trim()] =
              (bookCounts[item.book_title.trim()] || 0) + 1;
        });
        renderTopList(
          "topBooksList",
          Object.entries(bookCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5),
          "book"
        );
        const readerCounts = {};
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        data.forEach((item) => {
          if (
            new Date(item.borrow_date) >= oneWeekAgo &&
            item.status !== "pending"
          )
            readerCounts[item.student_name.trim()] =
              (readerCounts[item.student_name.trim()] || 0) + 1;
        });
        renderTopList(
          "topReadersList",
          Object.entries(readerCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5),
          "student"
        );
      }

      function renderTopList(elementId, items, type) {
        const div = document.getElementById(elementId);
        div.innerHTML = "";
        if (items.length === 0) {
          div.innerHTML = `<p style='text-align:center; color:#999; font-size:13px;'>${t(
            "no_data"
          )}</p>`;
          return;
        }
        items.forEach((item, index) => {
          let rankClass = "rank-circle";
          if (index === 0) rankClass += " rank-1";
          else if (index === 1) rankClass += " rank-2";
          else if (index === 2) rankClass += " rank-3";

          let nameHtml = item[0];
          if (type === "book")
            nameHtml = `<span class="clickable-name" onclick="openBookDetails('${item[0].replace(
              /'/g,
              "\\'"
            )}')">${item[0]}</span>`;
          if (type === "student")
            nameHtml = `<span class="clickable-name" onclick="openStudentDetails('${item[0].replace(
              /'/g,
              "\\'"
            )}')">${item[0]}</span>`;

          div.innerHTML += `<div class="list-item"><div style="display:flex; align-items:center;"><div class="${rankClass}">${
            index + 1
          }</div><div style="font-weight:500; font-size:14px;">${nameHtml}</div></div><div style="font-weight:700; color:var(--primary); font-size:14px;">${
            item[1]
          }</div></div>`;
        });
      }

      // --- NEW: MODAL DETAILS LOGIC ---
      async function openBookDetails(title) {
        document.getElementById("bookDetailsModal").style.display = "flex";
        document.getElementById("detailBookTitle").innerText = title;
        document.getElementById("detailBookContent").innerHTML = "Loading...";

        const logs = allLogs.filter(
          (l) => l.book_title === title && l.is_reflection_approved
        );

        let html = "";
        if (logs.length === 0)
          html =
            '<p style="text-align:center; color:#999;">H…ôl…ô r…ôy yoxdur.</p>';
        else {
          logs.forEach((l) => {
            const stars = l.rating ? "‚≠ê".repeat(l.rating) : "";
            html += `<div class="detail-item"><div class="detail-header">${l.student_name} <span style="font-weight:400; color:#666;">(${l.student_class})</span> ${stars}</div><div class="detail-text">${l.reflection}</div></div>`;
          });
        }
        document.getElementById("detailBookContent").innerHTML = html;
      }

      async function openStudentDetails(name) {
        document.getElementById("studentDetailsModal").style.display = "flex";

        // ≈ûagirdin sinfini tapmaq √º√ß√ºn loglardan birin…ô baxƒ±rƒ±q
        const studentLog = allLogs.find((l) => l.student_name === name);
        const className = studentLog ? studentLog.student_class : "";

        document.getElementById(
          "detailStudentName"
        ).innerHTML = `${name} <span style="font-size:14px; color:#666;">(${className})</span>`;
        document.getElementById("detailStudentContent").innerHTML =
          "Loading...";

        const logs = allLogs.filter((l) => l.student_name === name);

        let html = "";
        if (logs.length === 0)
          html =
            '<p style="text-align:center; color:#999;">M…ôlumat yoxdur.</p>';
        else {
          logs.forEach((l) => {
            const stars = l.rating ? "‚≠ê".repeat(l.rating) : "";
            const date = new Date(l.borrow_date).toLocaleDateString();
            const ref = l.reflection
              ? `<div class="detail-text">"${l.reflection}"</div>`
              : "";
            html += `<div class="detail-item"><div class="detail-header">${
              l.book_title
            }</div><div class="detail-sub"><span>${date}</span><span>${
              l.status === "returned" ? "‚úÖ Bitdi" : "üìñ Oxuyur"
            } ${stars}</span></div>${ref}</div>`;
          });
        }
        document.getElementById("detailStudentContent").innerHTML = html;
      }

      function filterAdminTable() {
        const query = document
          .getElementById("adminSearch")
          .value.toLowerCase();
        const filtered = allLogs.filter(
          (item) =>
            (item.student_name &&
              item.student_name.toLowerCase().includes(query)) ||
            (item.book_title && item.book_title.toLowerCase().includes(query))
        );
        renderAdminTable(filtered);
      }

      function renderAdminTable(data) {
        const tbody = document.getElementById("logsBody");
        tbody.innerHTML = "";
        const today = new Date();
        data.forEach((item) => {
          const borrowDate = new Date(item.borrow_date);
          let statusHtml = "",
            actionHtml = "",
            termHtml = "";
          let refIcon = "";
          if (item.reflection) {
            if (item.is_reflection_approved)
              refIcon = `<span class="admin-ref-icon approved">üí¨<div class="ref-tooltip">${
                item.rating ? "‚≠ê" + item.rating : ""
              } ${item.reflection}</div></span>`;
            else
              refIcon = `<span class="admin-ref-icon pending" onclick="approveReflection('${item.id}')">üì©<div class="ref-tooltip"><b>T…ôsdiq G√∂zl…ôyir!</b><br>${item.reflection}<br><small>(T…ôsdiql…ôm…ôk √º√ß√ºn bura bas)</small></div></span>`;
          }
          if (item.status === "pending") {
            statusHtml = `<span class="badge bg-yellow">${t(
              "status_pending"
            )}</span>`;
            termHtml = `<span style="color:#9ca3af; font-size:13px;">-</span>`;
            actionHtml = `<button onclick="approveBook('${
              item.id
            }')" class="btn-sm btn-approve">${t("btn_approve")}</button>`;
          } else if (item.status === "active") {
            const deadlineDate = new Date(borrowDate);
            deadlineDate.setDate(borrowDate.getDate() + 10);
            const diffTime = deadlineDate - today;
            const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            let badgeClass = "bg-green";
            if (daysLeft < 0) badgeClass = "bg-red";
            else if (daysLeft <= 3) badgeClass = "bg-yellow";
            termHtml = `<span class="badge ${badgeClass}">${daysLeft} ${t(
              "days_left"
            )}</span>`;
            statusHtml = `<span class="badge bg-green">${t(
              "status_active"
            )}</span>`;
            if (item.secret_code)
              statusHtml += `<br><span class="code-badge">${item.secret_code}</span>`;
            actionHtml = `<button onclick="returnBook('${
              item.id
            }')" class="btn-sm btn-return">${t("btn_return")}</button>`;
          } else if (item.status === "returned") {
            termHtml = `<span style="color:#9ca3af; font-size:13px;">-</span>`;
            statusHtml = `<span class="badge bg-gray">${t(
              "status_returned"
            )}</span>`;
            actionHtml = '<i class="fas fa-check" style="color:#10b981;"></i>';
          }
          tbody.innerHTML += `<tr><td><b>${
            item.student_name
          }</b><br><span style="font-size:12px; color:#9ca3af;">${
            item.student_class
          }</span></td><td>${
            item.book_title || t("unnamed")
          } ${refIcon}</td><td>${borrowDate.toLocaleDateString()}</td><td>${termHtml}</td><td>${statusHtml}</td><td style="text-align:right;">${actionHtml}</td></tr>`;
        });
      }

      function showAdmin() {
        document.getElementById("studentSection").classList.add("hidden");
        document.getElementById("adminSection").classList.remove("hidden");
        fetchAllLogsForSystem();
      }
      function showStudent() {
        document.getElementById("studentSection").classList.remove("hidden");
        document.getElementById("adminSection").classList.add("hidden");
        fetchAllLogsForSystem();
      }
      async function returnBook(id) {
        customConfirm(t("alert_return"), async () => {
          const now = new Date().toISOString();
          await sb
            .from("library_logs")
            .update({ status: "returned", returned_at: now })
            .eq("id", id);
          fetchAllLogsForSystem();
        });
      }

      function openModal(type) {
        if (type === "order") {
          document.getElementById("orderModal").style.display = "flex";
        } else if (type === "reflection") {
          document.getElementById("reflectionModal").style.display = "flex";
          document.getElementById("refStep1").classList.remove("hidden");
          document.getElementById("refStep2").classList.add("hidden");
          document.getElementById("refCode").value = "";
          document.getElementById("refText").value = "";
          setRating(0);
        } else if (type === "teacherLogin") {
          document.getElementById("teacherLoginModal").style.display = "flex";
        } else if (type === "bookDetails") {
          /* logic handled in onclick */
        } else if (type === "studentDetails") {
          /* logic handled in onclick */
        }
      }
      function closeModal(type) {
        if (type === "order")
          document.getElementById("orderModal").style.display = "none";
        else if (type === "reflection")
          document.getElementById("reflectionModal").style.display = "none";
        else if (type === "teacherLogin")
          document.getElementById("teacherLoginModal").style.display = "none";
        else if (type === "confirm")
          document.getElementById("confirmModal").style.display = "none";
        else if (type === "bookDetails")
          document.getElementById("bookDetailsModal").style.display = "none";
        else if (type === "studentDetails")
          document.getElementById("studentDetailsModal").style.display = "none";
      }
    </script>
  </body>
</html>
